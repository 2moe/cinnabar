<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  Module: Cinnabar::Command
  
    &mdash; Cinnabar
  
</title>

  <link rel="stylesheet" href="../css/style.css" type="text/css" />

  <link rel="stylesheet" href="../css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "Cinnabar::Command";
  relpath = '../';
</script>


  <script type="text/javascript" charset="utf-8" src="../js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="../js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="../class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="../_index.html">Index (C)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../Cinnabar.html" title="Cinnabar (module)">Cinnabar</a></span></span>
     &raquo; 
    <span class="title">Command</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><h1>Module: Cinnabar::Command
  
  
  
</h1>
<div class="box_info">
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/cinnabar/cmd_runner.rb<span class="defines">,<br />
  lib/cinnabar/cmd_runner.rb,<br /> lib/cinnabar/cmd_runner.rb</span>
</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>typed: false
frozen_string_literal: true</p>


  </div>
</div>
<div class="tags">
  

</div><h2>Defined Under Namespace</h2>
<p class="children">
  
    
      <strong class="modules">Modules:</strong> <span class='object_link'><a href="Command/ArrExt.html" title="Cinnabar::Command::ArrExt (module)">ArrExt</a></span>, <span class='object_link'><a href="Command/ArrMixin.html" title="Cinnabar::Command::ArrMixin (module)">ArrMixin</a></span>, <span class='object_link'><a href="Command/ArrRefin.html" title="Cinnabar::Command::ArrRefin (module)">ArrRefin</a></span>, <span class='object_link'><a href="Command/TaskArrExt.html" title="Cinnabar::Command::TaskArrExt (module)">TaskArrExt</a></span>, <span class='object_link'><a href="Command/TaskArrMixin.html" title="Cinnabar::Command::TaskArrMixin (module)">TaskArrMixin</a></span>, <span class='object_link'><a href="Command/TaskArrRefin.html" title="Cinnabar::Command::TaskArrRefin (module)">TaskArrRefin</a></span>
    
  
    
  
</p>







  
    <h2>
      Class Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#async_run-class_method" title="async_run (class method)">.<strong>async_run</strong>(cmd_arr, env_hash = nil, opts: {})  &#x21d2; Array(IO, Process::Waiter) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Launch a command asynchronously (non-blocking) and return its stdout stream and process waiter.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#normalize_env-class_method" title="normalize_env (class method)">.<strong>normalize_env</strong>(hash)  &#x21d2; Hash{String =&gt; String}<sup>?</sup> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>A hash where both keys and values are strings.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#run-class_method" title="run (class method)">.<strong>run</strong>(cmd_arr, env_hash = nil, opts: {})  &#x21d2; String<sup>?</sup> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Executes the command synchronously (blocking) and returns its standard output.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#run_cmd-class_method" title="run_cmd (class method)">.<strong>run_cmd</strong>(cmd_arr, env_hash = nil, opts: {})  &#x21d2; Boolean </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Executes a system command using Ruby&#39;s <code>Kernel.system</code>.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#wait_with_output-class_method" title="wait_with_output (class method)">.<strong>wait_with_output</strong>(io_fd, waiter)  &#x21d2; Array(String, Process::Status) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Waits for a process to finish and reads all remaining output from its stdout.</p>
</div></span>
  
</li>

      
    </ul>
  



  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="async_run-class_method">
  
    .<strong>async_run</strong>(cmd_arr, env_hash = nil, opts: {})  &#x21d2; <tt>Array(IO, Process::Waiter)</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Launch a command asynchronously (non-blocking) and return its stdout stream and process waiter.</p>

<p>This is a sugar over <strong>Open3.popen2</strong>, intended to start a subprocess
and <strong>immediately</strong> hand back:</p>

<ol>
<li>an <code>IO</code> for reading the command&#39;s stdout, and</li>
<li>a <code>Process::Waiter</code> (a thread-like object) that can be awaited later.</li>
</ol>

<ul>
<li>If <code>:stdin_data</code> is provided, the data will be written to
the child&#39;s stdin and the stdin will be closed.</li>
<li>When <code>:stdin_data</code> is absent, stdin is simply closed and
the method returns immediately without blocking on output.</li>
</ul>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
        <h5 class="example_title"><div class='inline'><p>start a process and later wait for it</p>
</div></h5>
      
      <pre class="example code"><code>
<span class='const'>Cmd</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../Cinnabar.html" title="Cinnabar (module)">Cinnabar</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="" title="Cinnabar::Command (module)">Command</a></span></span>
<span class='id identifier rubyid_stdout_fd'>stdout_fd</span><span class='comma'>,</span> <span class='id identifier rubyid_waiter'>waiter</span> <span class='op'>=</span> <span class='const'>Cmd</span><span class='period'>.</span><span class='id identifier rubyid_async_run'>async_run</span><span class='lparen'>(</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sh</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>-c</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>echo hello; sleep 1; echo done</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>

<span class='id identifier rubyid_output'>output</span><span class='comma'>,</span> <span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='const'>Cmd</span><span class='period'>.</span><span class='id identifier rubyid_wait_with_output'>wait_with_output</span><span class='lparen'>(</span><span class='id identifier rubyid_stdout_fd'>stdout_fd</span><span class='comma'>,</span> <span class='id identifier rubyid_waiter'>waiter</span><span class='rparen'>)</span></code></pre>
    
      
        <h5 class="example_title"><div class='inline'><p>pass stdin data</p>
</div></h5>
      
      <pre class="example code"><code>
<span class='const'>Cmd</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../Cinnabar.html" title="Cinnabar (module)">Cinnabar</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="" title="Cinnabar::Command (module)">Command</a></span></span>
<span class='id identifier rubyid_opts'>opts</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='label'>stdin_data:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Run in the background</span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
<span class='id identifier rubyid_io_and_waiter'>io_and_waiter</span> <span class='op'>=</span> <span class='const'>Cmd</span><span class='period'>.</span><span class='id identifier rubyid_async_run'>async_run</span><span class='lparen'>(</span><span class='qwords_beg'>%w[</span><span class='tstring_content'>wc</span><span class='words_sep'> </span><span class='tstring_content'>-m</span><span class='tstring_end'>]</span></span><span class='comma'>,</span> <span class='label'>opts:</span><span class='rparen'>)</span>

<span class='id identifier rubyid_output'>output</span><span class='comma'>,</span> <span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='const'>Cmd</span><span class='period'>.</span><span class='id identifier rubyid_wait_with_output'>wait_with_output</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_io_and_waiter'>io_and_waiter</span><span class='rparen'>)</span>
<span class='id identifier rubyid_status'>status</span><span class='period'>.</span><span class='id identifier rubyid_success?'>success?</span>   <span class='comment'>#=&gt; true
</span><span class='id identifier rubyid_output'>output</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>==</span> <span class='int'>21</span> <span class='comment'>#=&gt; true</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>cmd_arr</span>
      
      
        <span class='type'>(<tt>Array&lt;String&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The command and its arguments (e.g., <code>%w[printf hello]</code>).</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>env_hash</span>
      
      
        <span class='type'>(<tt>#to_h</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Optional environment variables;
keys/values will be normalized by <span class='object_link'>#normalize_env</span> before being passed to the child.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>opts</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>{}</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Additional options.</p>

<ul>
<li>Only the following keys are extracted and handled explicitly;

<ul>
<li>:stdin_data</li>
<li>:binmode</li>
<li>:stdin_binmode</li>
<li>:stdout_binmode</li>
</ul></li>
</ul>

<p>all other keys are passed through to <strong>Open3.popen2</strong> unchanged.</p>
</div>
      
    </li>
  
</ul>

  
    
    
    
    
    
    
    <p class="tag_title">Options Hash (<tt>opts:</tt>):</p>
    <ul class="option">
      
        <li>
          <span class="name">:stdin_data</span>
          <span class="type">(<tt>String</tt>, <tt>#readpartial</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'><p>Data to write to the child&#39;s stdin. If it responds to <code>#readpartial</code>,
it will be streamed via <strong>IO.copy_stream</strong>;</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:binmode</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'><p>When <code>true</code>, set both stdin and stdout to binary mode (useful for binary data).</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:stdin_binmode</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'><p>Sets only stdin to binary mode.</p>
</div>
          
        </li>
      
        <li>
          <span class="name">:stdout_binmode</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'><p>Sets only stdout to binary mode.</p>
</div>
          
        </li>
      
    </ul>
  

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Array(IO, Process::Waiter)</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>A pair <code>[stdout_io, waiter]</code>:</p>

<ul>
<li><code>stdout_io</code> is an <code>IO</code> for reading <strong>stdout</strong></li>
<li><code>waiter</code> is a <code>Process::Waiter</code>;

<ul>
<li>call <code>waiter.value</code> to get <code>Process::Status</code>;</li>
<li>or <code>waiter.join</code> to block until the process exits.</li>
</ul></li>
</ul>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt>StandardError</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Reraises any non-<code>Errno::EPIPE</code> exception encountered while writing to stdin.
<code>Errno::EPIPE</code> is logged and swallowed.</p>
</div>
      
    </li>
  
</ul>

  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><span class='object_link'><a href="#wait_with_output-class_method" title="Cinnabar::Command.wait_with_output (method)">wait_with_output</a></span></li>
    
      <li><span class='object_link'><a href="#run-class_method" title="Cinnabar::Command.run (method)">run</a></span></li>
    
  </ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/cinnabar/cmd_runner.rb', line 206</span>

<span class='kw'>def</span> <span class='id identifier rubyid_async_run'>async_run</span><span class='lparen'>(</span><span class='id identifier rubyid_cmd_arr'>cmd_arr</span><span class='comma'>,</span> <span class='id identifier rubyid_env_hash'>env_hash</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>opts:</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='comment'># rubocop:disable Metrics/MethodLength,Metrics/AbcSize,Metrics/PerceivedComplexity,Metrics/CyclomaticComplexity
</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Asynchronously executing system command: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_cmd_arr'>cmd_arr</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='period'>.</span><span class='id identifier rubyid_log_dbg'>log_dbg</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>opts: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_opts'>opts</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='period'>.</span><span class='id identifier rubyid_log_dbg'>log_dbg</span>

  <span class='id identifier rubyid_stdin_data'>stdin_data</span> <span class='op'>=</span> <span class='id identifier rubyid_opts'>opts</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='symbol'>:stdin_data</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_binmode'>binmode</span> <span class='op'>=</span> <span class='id identifier rubyid_opts'>opts</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='symbol'>:binmode</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_stdin_binmode'>stdin_binmode</span> <span class='op'>=</span> <span class='id identifier rubyid_opts'>opts</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='symbol'>:stdin_binmode</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_stdout_binmode'>stdout_binmode</span> <span class='op'>=</span> <span class='id identifier rubyid_opts'>opts</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='symbol'>:stdout_binmode</span><span class='rparen'>)</span>

  <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>async_run() does not support the :allow_failure option.</span><span class='tstring_end'>&#39;</span></span><span class='period'>.</span><span class='id identifier rubyid_log_warn'>log_warn</span> <span class='kw'>if</span> <span class='id identifier rubyid_opts'>opts</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='symbol'>:allow_failure</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_final_env'>final_env</span> <span class='op'>=</span> <span class='id identifier rubyid_normalize_env'>normalize_env</span><span class='lparen'>(</span><span class='id identifier rubyid_env_hash'>env_hash</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_stdin'>stdin</span><span class='comma'>,</span> <span class='id identifier rubyid_stdout'>stdout</span><span class='comma'>,</span> <span class='id identifier rubyid_waiter'>waiter</span> <span class='op'>=</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_final_env'>final_env</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
      <span class='const'>Open3</span><span class='period'>.</span><span class='id identifier rubyid_popen2'>popen2</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_cmd_arr'>cmd_arr</span><span class='comma'>,</span> <span class='id identifier rubyid_opts'>opts</span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='const'>Open3</span><span class='period'>.</span><span class='id identifier rubyid_popen2'>popen2</span><span class='lparen'>(</span><span class='id identifier rubyid_final_env'>final_env</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_cmd_arr'>cmd_arr</span><span class='comma'>,</span> <span class='id identifier rubyid_opts'>opts</span><span class='rparen'>)</span>
    <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_binmode'>binmode</span>
    <span class='id identifier rubyid_stdin'>stdin</span><span class='period'>.</span><span class='id identifier rubyid_binmode'>binmode</span>
    <span class='id identifier rubyid_stdout'>stdout</span><span class='period'>.</span><span class='id identifier rubyid_binmode'>binmode</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_stdin'>stdin</span><span class='period'>.</span><span class='id identifier rubyid_binmode'>binmode</span> <span class='kw'>if</span> <span class='id identifier rubyid_stdin_binmode'>stdin_binmode</span>
    <span class='id identifier rubyid_stdout'>stdout</span><span class='period'>.</span><span class='id identifier rubyid_binmode'>binmode</span> <span class='kw'>if</span> <span class='id identifier rubyid_stdout_binmode'>stdout_binmode</span>
  <span class='kw'>end</span>

  <span class='comment'># Non-blocking: no stdin to write; return immediately
</span>  <span class='kw'>unless</span> <span class='id identifier rubyid_stdin_data'>stdin_data</span>
    <span class='id identifier rubyid_stdin'>stdin</span><span class='period'>.</span><span class='id identifier rubyid_close'>close</span>
    <span class='kw'>return</span> <span class='lbracket'>[</span><span class='id identifier rubyid_stdout'>stdout</span><span class='comma'>,</span> <span class='id identifier rubyid_waiter'>waiter</span><span class='rbracket'>]</span>
  <span class='kw'>end</span>

  <span class='kw'>begin</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_stdin_data'>stdin_data</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span> <span class='symbol'>:readpartial</span>
      <span class='const'>IO</span><span class='period'>.</span><span class='id identifier rubyid_copy_stream'>copy_stream</span><span class='lparen'>(</span><span class='id identifier rubyid_stdin_data'>stdin_data</span><span class='comma'>,</span> <span class='id identifier rubyid_stdin'>stdin</span><span class='rparen'>)</span>
    <span class='kw'>else</span>
      <span class='id identifier rubyid_stdin'>stdin</span><span class='period'>.</span><span class='id identifier rubyid_write'>write</span> <span class='id identifier rubyid_stdin_data'>stdin_data</span>
    <span class='kw'>end</span>
  <span class='kw'>rescue</span> <span class='const'>Errno</span><span class='op'>::</span><span class='const'>EPIPE</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_log_err'>log_err</span>
  <span class='kw'>rescue</span> <span class='const'>StandardError</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Failed to write stdin data: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='period'>.</span><span class='id identifier rubyid_log_err'>log_err</span>
    <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span>
  <span class='kw'>ensure</span>
    <span class='id identifier rubyid_stdin'>stdin</span><span class='period'>.</span><span class='id identifier rubyid_close'>close</span>
  <span class='kw'>end</span>
  <span class='lbracket'>[</span><span class='id identifier rubyid_stdout'>stdout</span><span class='comma'>,</span> <span class='id identifier rubyid_waiter'>waiter</span><span class='rbracket'>]</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="normalize_env-class_method">
  
    .<strong>normalize_env</strong>(hash)  &#x21d2; <tt>Hash{String =&gt; String}</tt><sup>?</sup> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Returns a hash where both keys and values are strings.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>hash</span>
      
      
        <span class='type'>(<tt>#to_h</tt>)</span>
      
      
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Hash{String =&gt; String}</tt>, <tt>nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>a hash where both keys and values are strings</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


129
130
131
132
133
134
135</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/cinnabar/cmd_runner.rb', line 129</span>

<span class='kw'>def</span> <span class='id identifier rubyid_normalize_env'>normalize_env</span><span class='lparen'>(</span><span class='id identifier rubyid_hash'>hash</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='kw'>nil</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
  <span class='kw'>return</span> <span class='kw'>nil</span> <span class='kw'>if</span> <span class='id identifier rubyid_hash'>hash</span><span class='period'>.</span><span class='id identifier rubyid_respond_to?'>respond_to?</span><span class='lparen'>(</span><span class='symbol'>:empty?</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_hash'>hash</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span>

  <span class='id identifier rubyid_hash'>hash</span><span class='period'>.</span><span class='id identifier rubyid_to_h'>to_h</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='op'>|</span> <span class='lbracket'>[</span><span class='id identifier rubyid_k'>k</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span> <span class='id identifier rubyid_v'>v</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
    <span class='period'>.</span><span class='id identifier rubyid_tap'>tap</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>normalized_env:</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid__1'>_1</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='period'>.</span><span class='id identifier rubyid_log_dbg'>log_dbg</span> <span class='rbrace'>}</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="run-class_method">
  
    .<strong>run</strong>(cmd_arr, env_hash = nil, opts: {})  &#x21d2; <tt>String</tt><sup>?</sup> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Executes the command synchronously (blocking) and returns its standard output.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
        <h5 class="example_title"><div class='inline'><p>pass env</p>
</div></h5>
      
      <pre class="example code"><code>
<span class='const'>Cmd</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../Cinnabar.html" title="Cinnabar (module)">Cinnabar</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="" title="Cinnabar::Command (module)">Command</a></span></span>
<span class='id identifier rubyid_cmd_arr'>cmd_arr</span> <span class='op'>=</span> <span class='qwords_beg'>%w[</span><span class='tstring_content'>sh</span><span class='words_sep'> </span><span class='tstring_content'>-c</span><span class='tstring_end'>]</span></span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>printf $WW</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_env_hash'>env_hash</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='label'>WW:</span> <span class='int'>2</span><span class='rbrace'>}</span>
<span class='id identifier rubyid_opts'>opts</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='label'>allow_failure:</span> <span class='kw'>true</span><span class='rbrace'>}</span>
<span class='id identifier rubyid_output'>output</span> <span class='op'>=</span> <span class='const'>Cmd</span><span class='period'>.</span><span class='id identifier rubyid_run'>run</span><span class='lparen'>(</span><span class='id identifier rubyid_cmd_arr'>cmd_arr</span><span class='comma'>,</span> <span class='id identifier rubyid_env_hash'>env_hash</span><span class='comma'>,</span> <span class='label'>opts:</span><span class='rparen'>)</span>
<span class='id identifier rubyid_output'>output</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>==</span> <span class='int'>2</span> <span class='comment'>#=&gt; true</span></code></pre>
    
      
        <h5 class="example_title"><div class='inline'><p>pass stdin data</p>
</div></h5>
      
      <pre class="example code"><code>
<span class='id identifier rubyid_opts'>opts</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='label'>stdin_data:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Hello\nWorld\n</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>
<span class='id identifier rubyid_output'>output</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../Cinnabar.html" title="Cinnabar (module)">Cinnabar</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="" title="Cinnabar::Command (module)">Command</a></span></span><span class='period'>.</span><span class='id identifier rubyid_run'>run</span><span class='lparen'>(</span><span class='qwords_beg'>%w[</span><span class='tstring_content'>wc</span><span class='words_sep'> </span><span class='tstring_content'>-l</span><span class='tstring_end'>]</span></span><span class='comma'>,</span> <span class='label'>opts:</span><span class='rparen'>)</span>
<span class='id identifier rubyid_output'>output</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span> <span class='op'>==</span> <span class='int'>2</span> <span class='comment'>#=&gt; true</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>cmd_arr</span>
      
      
        <span class='type'>(<tt>Array&lt;String&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The command and its arguments (e.g., <code>%w[printf hello]</code>).</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>env_hash</span>
      
      
        <span class='type'>(<tt>#to_h</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Environment variables to pass to the command.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>opts</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>{}</tt>)</em>
      
      
        &mdash;
        <div class='inline'><ul>
<li>Only the <code>:allow_failure</code> is extracted and handled explicitly;</li>
<li>all other keys are passed through to <strong>Open3.capture2</strong> unchanged.</li>
</ul>
</div>
      
    </li>
  
</ul>

  
    
    
    
    
    
    
    <p class="tag_title">Options Hash (<tt>opts:</tt>):</p>
    <ul class="option">
      
        <li>
          <span class="name">:allow_failure</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'><p>Indicates whether the command is allowed to fail.</p>
</div>
          
        </li>
      
    </ul>
  

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>String</tt>, <tt>nil</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>the standard output of the command.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt>RuntimeError</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>when <code>allow_failure: false</code> and the process exits with non-zero status</p>
</div>
      
    </li>
  
</ul>

  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><span class='object_link'><a href="#async_run-class_method" title="Cinnabar::Command.async_run (method)">async_run</a></span></li>
    
  </ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/cinnabar/cmd_runner.rb', line 42</span>

<span class='kw'>def</span> <span class='id identifier rubyid_run'>run</span><span class='lparen'>(</span><span class='id identifier rubyid_cmd_arr'>cmd_arr</span><span class='comma'>,</span> <span class='id identifier rubyid_env_hash'>env_hash</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>opts:</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span> <span class='comment'># rubocop:disable Metrics/MethodLength,Metrics/AbcSize,Metrics/CyclomaticComplexity,Metrics/PerceivedComplexity
</span>  <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Running and capturing the output of a system command.</span><span class='tstring_end'>&#39;</span></span><span class='period'>.</span><span class='id identifier rubyid_log_dbg'>log_dbg</span>
  <span class='id identifier rubyid_cmd_arr'>cmd_arr</span><span class='period'>.</span><span class='id identifier rubyid_log_info'>log_info</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>opts: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_opts'>opts</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='period'>.</span><span class='id identifier rubyid_log_dbg'>log_dbg</span>

  <span class='id identifier rubyid_allow_failure'>allow_failure</span> <span class='op'>=</span> <span class='id identifier rubyid_opts'>opts</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='symbol'>:allow_failure</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='kw'>false</span>

  <span class='id identifier rubyid_final_env'>final_env</span> <span class='op'>=</span> <span class='id identifier rubyid_normalize_env'>normalize_env</span><span class='lparen'>(</span><span class='id identifier rubyid_env_hash'>env_hash</span><span class='rparen'>)</span>

  <span class='kw'>begin</span>
    <span class='id identifier rubyid_stdout'>stdout</span><span class='comma'>,</span> <span class='id identifier rubyid_status'>status</span> <span class='op'>=</span>
      <span class='kw'>if</span> <span class='id identifier rubyid_final_env'>final_env</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
        <span class='const'>Open3</span><span class='period'>.</span><span class='id identifier rubyid_capture2'>capture2</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_cmd_arr'>cmd_arr</span><span class='comma'>,</span> <span class='id identifier rubyid_opts'>opts</span><span class='rparen'>)</span>
      <span class='kw'>else</span>
        <span class='const'>Open3</span><span class='period'>.</span><span class='id identifier rubyid_capture2'>capture2</span><span class='lparen'>(</span><span class='id identifier rubyid_final_env'>final_env</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_cmd_arr'>cmd_arr</span><span class='comma'>,</span> <span class='id identifier rubyid_opts'>opts</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
  <span class='kw'>rescue</span> <span class='const'>StandardError</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
    <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_e'>e</span> <span class='kw'>unless</span> <span class='id identifier rubyid_allow_failure'>allow_failure</span>
    <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_log_err'>log_err</span>
    <span class='kw'>return</span> <span class='id identifier rubyid_stdout'>stdout</span>
  <span class='kw'>end</span>

  <span class='kw'>return</span> <span class='id identifier rubyid_stdout'>stdout</span> <span class='kw'>if</span> <span class='id identifier rubyid_status'>status</span><span class='period'>.</span><span class='id identifier rubyid_success?'>success?</span>

  <span class='id identifier rubyid_err_msg'>err_msg</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Command failed: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_cmd_arr'>cmd_arr</span><span class='period'>.</span><span class='id identifier rubyid_join'>join</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'> </span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_raise'>raise</span> <span class='id identifier rubyid_err_msg'>err_msg</span> <span class='kw'>unless</span> <span class='id identifier rubyid_allow_failure'>allow_failure</span>

  <span class='id identifier rubyid_err_msg'>err_msg</span><span class='period'>.</span><span class='id identifier rubyid_log_err'>log_err</span>
  <span class='id identifier rubyid_stdout'>stdout</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="run_cmd-class_method">
  
    .<strong>run_cmd</strong>(cmd_arr, env_hash = nil, opts: {})  &#x21d2; <tt>Boolean</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Executes a system command using Ruby&#39;s <code>Kernel.system</code>.</p>

<p>It runs the command synchronously, blocks until completion, and does not capture stdout or stderr.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
        <h5 class="example_title"><div class='inline'><p>pwd</p>
</div></h5>
      
      <pre class="example code"><code>
<span class='const'>Cmd</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../Cinnabar.html" title="Cinnabar (module)">Cinnabar</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="" title="Cinnabar::Command (module)">Command</a></span></span>
<span class='id identifier rubyid_opts'>opts</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='label'>chdir:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>/tmp</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>allow_failure:</span> <span class='kw'>true</span><span class='rbrace'>}</span>
<span class='const'>Cmd</span><span class='period'>.</span><span class='id identifier rubyid_run_cmd'>run_cmd</span><span class='lparen'>(</span><span class='qwords_beg'>%w[</span><span class='tstring_content'>pwd</span><span class='tstring_end'>]</span></span><span class='comma'>,</span> <span class='label'>opts:</span><span class='rparen'>)</span></code></pre>
    
      
        <h5 class="example_title"><div class='inline'><p>pass env</p>
</div></h5>
      
      <pre class="example code"><code>
<span class='const'>Cmd</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../Cinnabar.html" title="Cinnabar (module)">Cinnabar</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="" title="Cinnabar::Command (module)">Command</a></span></span>
<span class='id identifier rubyid_cmd_arr'>cmd_arr</span> <span class='op'>=</span> <span class='qwords_beg'>%w[</span><span class='tstring_content'>sh</span><span class='words_sep'> </span><span class='tstring_content'>-c</span><span class='tstring_end'>]</span></span> <span class='op'>&lt;&lt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>printf $WW</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_env_hash'>env_hash</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='label'>WW:</span> <span class='int'>2</span><span class='rbrace'>}</span>
<span class='const'>Cmd</span><span class='period'>.</span><span class='id identifier rubyid_run_cmd'>run_cmd</span><span class='lparen'>(</span><span class='id identifier rubyid_cmd_arr'>cmd_arr</span><span class='comma'>,</span> <span class='id identifier rubyid_env_hash'>env_hash</span><span class='rparen'>)</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>cmd_arr</span>
      
      
        <span class='type'>(<tt>Array&lt;String&gt;</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The command and its arguments as an array,
e.g., <code>%w[ls -lh]</code>.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>env_hash</span>
      
      
        <span class='type'>(<tt>#to_h</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>nil</tt>)</em>
      
      
        &mdash;
        <div class='inline'><p>Environment variables to pass to the command.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>opts</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
        <em class="default">(defaults to: <tt>{}</tt>)</em>
      
      
        &mdash;
        <div class='inline'><ul>
<li>Only the <code>:allow_failure</code> is extracted and handled explicitly;</li>
<li>all other keys are passed through to <code>Kernel.system</code> unchanged.</li>
</ul>
</div>
      
    </li>
  
</ul>

  
    
    
    
    
    
    
    <p class="tag_title">Options Hash (<tt>opts:</tt>):</p>
    <ul class="option">
      
        <li>
          <span class="name">:allow_failure</span>
          <span class="type">(<tt>Boolean</tt>)</span>
          <span class="default">
            
          </span>
          
            &mdash; <div class='inline'><p>Indicates whether the command is allowed to fail.
If true, the method will return false instead of raising an exception when the
command exits with a non-zero status.</p>
</div>
          
        </li>
      
    </ul>
  

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Returns true if the command succeeds (exit status 0),
or false if it fails and <code>allow_failure</code> is true.</p>
</div>
      
    </li>
  
</ul>
<p class="tag_title">Raises:</p>
<ul class="raise">
  
    <li>
      
      
        <span class='type'>(<tt>RuntimeError</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Raises an error if the command fails and <code>allow_failure</code> is false.</p>
</div>
      
    </li>
  
</ul>

  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><a href="https://docs.ruby-lang.org/en/3.4/Process.html#module-Process-label-Execution+Options" target="_parent" title="https://docs.ruby-lang.org/en/3.4/Process.html#module-Process-label-Execution+Options">https://docs.ruby-lang.org/en/3.4/Process.html#module-Process-label-Execution+Options</a></li>
    
  </ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/cinnabar/cmd_runner.rb', line 109</span>

<span class='kw'>def</span> <span class='id identifier rubyid_run_cmd'>run_cmd</span><span class='lparen'>(</span><span class='id identifier rubyid_cmd_arr'>cmd_arr</span><span class='comma'>,</span> <span class='id identifier rubyid_env_hash'>env_hash</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='label'>opts:</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
  <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Running system command</span><span class='tstring_end'>&#39;</span></span><span class='period'>.</span><span class='id identifier rubyid_log_dbg'>log_dbg</span>
  <span class='id identifier rubyid_cmd_arr'>cmd_arr</span><span class='period'>.</span><span class='id identifier rubyid_log_info'>log_info</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>opts: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_opts'>opts</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='period'>.</span><span class='id identifier rubyid_log_dbg'>log_dbg</span>

  <span class='id identifier rubyid_allow_failure'>allow_failure</span> <span class='op'>=</span> <span class='id identifier rubyid_opts'>opts</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='symbol'>:allow_failure</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='kw'>false</span>
  <span class='id identifier rubyid_exception'>exception</span> <span class='op'>=</span> <span class='op'>!</span><span class='id identifier rubyid_allow_failure'>allow_failure</span>
  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>exception: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_exception'>exception</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='period'>.</span><span class='id identifier rubyid_log_dbg'>log_dbg</span>
  <span class='id identifier rubyid_options'>options</span> <span class='op'>=</span> <span class='id identifier rubyid_opts'>opts</span><span class='period'>.</span><span class='id identifier rubyid_merge'>merge</span><span class='lparen'>(</span><span class='lbrace'>{</span> <span class='label'>exception:</span> <span class='rbrace'>}</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_final_env'>final_env</span> <span class='op'>=</span> <span class='id identifier rubyid_normalize_env'>normalize_env</span><span class='lparen'>(</span><span class='id identifier rubyid_env_hash'>env_hash</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_final_env'>final_env</span><span class='period'>.</span><span class='id identifier rubyid_nil?'>nil?</span>
    <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_system'>system</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_cmd_arr'>cmd_arr</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span><span class='rparen'>)</span>
  <span class='kw'>else</span>
    <span class='const'>Kernel</span><span class='period'>.</span><span class='id identifier rubyid_system'>system</span><span class='lparen'>(</span><span class='id identifier rubyid_final_env'>final_env</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_cmd_arr'>cmd_arr</span><span class='comma'>,</span> <span class='id identifier rubyid_options'>options</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="wait_with_output-class_method">
  
    .<strong>wait_with_output</strong>(io_fd, waiter)  &#x21d2; <tt>Array(String, Process::Status)</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
  <div class="note notetag">
    <strong>Note:</strong>
    <div class='inline'><p>This method blocks until the process exits and all output is read.</p>
</div>
  </div>

<p>Waits for a process to finish and reads all remaining output from its stdout.</p>


  </div>
</div>
<div class="tags">
  
  <div class="examples">
    <h4 class="tag_title">Examples:</h4>
    
      
        <h5 class="example_title"><div class='inline'><p>Wait for process and capture output</p>
</div></h5>
      
      <pre class="example code"><code>
<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sinlog</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_using'>using</span> <span class='const'>Sinlog</span><span class='op'>::</span><span class='const'>Refin</span>

<span class='const'>Cmd</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="../Cinnabar.html" title="Cinnabar (module)">Cinnabar</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="" title="Cinnabar::Command (module)">Command</a></span></span>

<span class='id identifier rubyid_fd'>fd</span><span class='comma'>,</span> <span class='id identifier rubyid_waiter'>waiter</span> <span class='op'>=</span> <span class='qwords_beg'>%w[</span><span class='tstring_content'>ruby</span><span class='words_sep'> </span><span class='tstring_content'>-e</span><span class='tstring_end'>]</span></span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>sleep 2; puts &quot;OK&quot;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
              <span class='period'>.</span><span class='id identifier rubyid_then'>then</span> <span class='lbrace'>{</span> <span class='const'>Cmd</span><span class='period'>.</span><span class='id identifier rubyid_async_run'>async_run</span><span class='lparen'>(</span><span class='id identifier rubyid__1'>_1</span><span class='rparen'>)</span> <span class='rbrace'>}</span>

<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>You can now do other things without waiting for the process to complete.</span><span class='tstring_end'>&quot;</span></span><span class='period'>.</span><span class='id identifier rubyid_log_dbg'>log_dbg</span>

<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>blocking wait</span><span class='tstring_end'>&quot;</span></span><span class='period'>.</span><span class='id identifier rubyid_log_info'>log_info</span>
<span class='id identifier rubyid_output'>output</span><span class='comma'>,</span> <span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='const'>Cmd</span><span class='period'>.</span><span class='id identifier rubyid_wait_with_output'>wait_with_output</span><span class='lparen'>(</span><span class='id identifier rubyid_fd'>fd</span><span class='comma'>,</span> <span class='id identifier rubyid_waiter'>waiter</span><span class='rparen'>)</span>

<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Exit code: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_status'>status</span><span class='period'>.</span><span class='id identifier rubyid_exitstatus'>exitstatus</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='period'>.</span><span class='id identifier rubyid_log_warn'>log_warn</span> <span class='kw'>unless</span> <span class='id identifier rubyid_status'>status</span><span class='period'>.</span><span class='id identifier rubyid_success?'>success?</span>
<span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Output:\n</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_output'>output</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='period'>.</span><span class='id identifier rubyid_log_info'>log_info</span></code></pre>
    
  </div>
<p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>io_fd</span>
      
      
        <span class='type'>(<tt>IO</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The IO object connected to the process&#39;s stdout (or combined stdout &amp; stderr).</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>waiter</span>
      
      
        <span class='type'>(<tt>Process::Waiter</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The waiter thread returned by <strong>Open3.popen2</strong> or <strong>Open3.popen2e</strong>.</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Array(String, Process::Status)</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>A two-element array:</p>

<ul>
<li>The full output read from <code>io_fd</code>.</li>
<li>The <strong>Process::Status</strong> object representing the process&#39;s exit status.</li>
</ul>
</div>
      
    </li>
  
</ul>

  <p class="tag_title">See Also:</p>
  <ul class="see">
    
      <li><span class='object_link'><a href="#async_run-class_method" title="Cinnabar::Command.async_run (method)">async_run</a></span></li>
    
  </ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


287
288
289
290
291
292</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/cinnabar/cmd_runner.rb', line 287</span>

<span class='kw'>def</span> <span class='id identifier rubyid_wait_with_output'>wait_with_output</span><span class='lparen'>(</span><span class='id identifier rubyid_io_fd'>io_fd</span><span class='comma'>,</span> <span class='id identifier rubyid_waiter'>waiter</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_status'>status</span> <span class='op'>=</span> <span class='id identifier rubyid_waiter'>waiter</span><span class='period'>.</span><span class='id identifier rubyid_value'>value</span>
  <span class='id identifier rubyid_output'>output</span> <span class='op'>=</span> <span class='id identifier rubyid_io_fd'>io_fd</span><span class='period'>.</span><span class='id identifier rubyid_read'>read</span>
  <span class='id identifier rubyid_io_fd'>io_fd</span><span class='period'>.</span><span class='id identifier rubyid_close'>close</span>
  <span class='lbracket'>[</span><span class='id identifier rubyid_output'>output</span><span class='comma'>,</span> <span class='id identifier rubyid_status'>status</span><span class='rbracket'>]</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

      <div id="footer">
  Generated on Wed Jan 14 08:32:48 2026 by
  <a href="https://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.38 (ruby-4.0.1).
</div>

    </div>
  </body>
</html>